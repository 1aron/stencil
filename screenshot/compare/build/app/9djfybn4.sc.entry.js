/*! Built with http://stenciljs.com */
const{h:e}=window.App;class t{navToId(e){e.preventDefault(),e.stopPropagation()}render(){const t=this.diff,i="number"==typeof t.mismatchedPixels,s=i?t.mismatchedPixels/(t.width*t.deviceScaleFactor*(t.height*t.deviceScaleFactor)):null;let a="";return i?t.mismatchedPixels>0&&(a="has-mismatch"):a="not-calculated",[e("p",{class:"test-path"},t.testPath),e("dl",null,e("div",null,e("dt",null,"Diff"),e("dd",null,e("a",{href:"#diff-"+t.id,onClick:this.navToId.bind(this)},t.id))),e("div",{class:a},e("dt",null,"Mismatched Pixels"),e("dd",null,i?t.mismatchedPixels:"--")),e("div",{class:a},e("dt",null,"Mismatched Ratio"),e("dd",null,i?s.toFixed(4):"--")),e("div",null,e("dt",null,"Device"),e("dd",null,t.device)),e("div",null,e("dt",null,"Width"),e("dd",null,t.width)),e("div",null,e("dt",null,"Height"),e("dd",null,t.height)),e("div",null,e("dt",null,"Device Scale Factor"),e("dd",null,t.deviceScaleFactor)),e("div",{class:"desc"},e("dt",null,"Description"),e("dd",null,t.desc)))]}static get is(){return"compare-analysis"}static get encapsulation(){return"shadow"}static get properties(){return{diff:{type:"Any",attr:"diff"}}}static get style(){return".test-path.sc-compare-analysis{margin-top:0;padding-top:0;font-size:10px;color:var(--analysis-data-color)}dl.sc-compare-analysis{padding:0;margin:0;font-size:var(--analysis-data-font-size);line-height:28px}div.sc-compare-analysis{display:-webkit-box;display:-ms-flexbox;display:flex;width:260px}dt.sc-compare-analysis{display:inline;-webkit-box-flex:2;-ms-flex:2;flex:2;font-weight:500}dd.sc-compare-analysis{display:inline;-webkit-box-flex:1;-ms-flex:1;flex:1;color:var(--analysis-data-color)}.desc.sc-compare-analysis, .desc.sc-compare-analysis   dt.sc-compare-analysis{display:block}.desc.sc-compare-analysis   dd.sc-compare-analysis{display:block;margin:0;line-height:22px}.not-calculated.sc-compare-analysis   dd.sc-compare-analysis{color:#ccc}.has-mismatch.sc-compare-analysis   dd.sc-compare-analysis{color:#ff6200}p.sc-compare-analysis{padding-top:14px;font-size:var(--analysis-data-font-size)}a.sc-compare-analysis{color:var(--analysis-data-color)}a.sc-compare-analysis:hover{text-decoration:none}"}}class i{render(){const t=this.diffs.reduce((e,t)=>(e.some(e=>e.value===t.device)||e.push({text:t.device,value:t.device}),e),[{text:"All Devices",value:""}]);return e("section",null,e("div",{class:"showing"},"Showing ",this.diffs.filter(e=>!e.hidden).length),e("div",{class:"search"},e("input",{type:"search",onInput:e=>{this.filterChange.emit({search:e.target.value})},value:this.filter.search||""})),t.length>1?e("div",{class:"device"},e("select",{onInput:e=>{this.filterChange.emit({device:e.target.value})}},t.map(t=>e("option",{key:t.value,selected:t.value===this.filter.device,value:t.value},t.text)))):null,e("div",{class:"mismatch"},e("select",{onInput:e=>{this.filterChange.emit({mismatch:e.target.value})}},e("option",{value:"",selected:""===this.filter.mismatch},"> 0"),e("option",{value:"100",selected:"100"===this.filter.mismatch},"> 100"),e("option",{value:"250",selected:"250"===this.filter.mismatch},"> 250"),e("option",{value:"500",selected:"500"===this.filter.mismatch},"> 500"),e("option",{value:"1000",selected:"1000"===this.filter.mismatch},"> 1,000"),e("option",{value:"2500",selected:"2500"===this.filter.mismatch},"> 2,500"),e("option",{value:"5000",selected:"5000"===this.filter.mismatch},"> 5,000"),e("option",{value:"10000",selected:"10000"===this.filter.mismatch},"> 10,000"),e("option",{value:"all",selected:"all"===this.filter.mismatch},"All Screenshots"))))}static get is(){return"compare-filter"}static get encapsulation(){return"shadow"}static get properties(){return{diffs:{type:"Any",attr:"diffs"},filter:{type:"Any",attr:"filter"}}}static get events(){return[{name:"filterChange",method:"filterChange",bubbles:!0,cancelable:!0,composed:!0}]}static get style(){return"input.sc-compare-filter, select.sc-compare-filter{font-size:10px}.showing.sc-compare-filter{font-size:12px;white-space:nowrap;margin:17px 8px 0 0;color:var(--analysis-data-color)}section.sc-compare-filter{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end}.device.sc-compare-filter, .mismatch.sc-compare-filter, .search.sc-compare-filter{margin:13px 8px 0 0}"}}class s{constructor(){this.repo=null}logoClick(e){e.preventDefault(),e.stopPropagation(),document.querySelector(".scroll-y").scrollTop=0}render(){return[this.repo?e("nav",{class:"breadcrumbs"},e("a",{href:this.repo.orgUrl},this.repo.orgUrl),e("a",{href:this.repo.repoUrl},this.repo.repoName),e("a",{href:this.repo.commitsUrl},"commits")):null,e("header",null,e("div",{class:"logo"},e("a",{href:"#",onClick:this.logoClick.bind(this)},e("img",{src:this.appSrcUrl+"/assets/logo.png"}))),e("compare-filter",{diffs:this.diffs,filter:this.filter}))]}static get is(){return"compare-header"}static get encapsulation(){return"shadow"}static get properties(){return{appSrcUrl:{type:String,attr:"app-src-url"},diffs:{type:"Any",attr:"diffs"},filter:{type:"Any",attr:"filter"},repo:{type:"Any",attr:"repo"}}}static get style(){return".sc-compare-header-h{background:#fff;-webkit-box-shadow:var(--header-box-shadow);box-shadow:var(--header-box-shadow)}nav.sc-compare-header{padding:4px}nav.sc-compare-header   a.sc-compare-header{font-size:14px;text-decoration:none;color:var(--breadcrumb-color);display:inline-block;padding:0 4px}nav.sc-compare-header   a.sc-compare-header:hover{text-decoration:underline}header.sc-compare-header{display:-webkit-box;display:-ms-flexbox;display:flex;width:calc(100% - 115px);padding:8px}img.sc-compare-header{width:174px;height:32px}.logo.sc-compare-header{-webkit-box-flex:1;-ms-flex:1;flex:1;padding:7px}compare-filter.sc-compare-header{-webkit-box-flex:1;-ms-flex:1;flex:1}h1.sc-compare-header{margin:0;padding:0;font-size:18px}"}}function a(e,t){return`screenshot_mismatch_${e}_${t}`}var l=function(e,t,i,s,a,l){l||(l={});for(var d=void 0===l.threshold?.1:l.threshold,h=35215*d*d,u=0,g=0;g<a;g++)for(var f=0;f<s;f++){var p=4*(g*s+f);if(c(e,t,p,p)>h)l.includeAA||!r(e,f,g,s,a,t)&&!r(t,f,g,s,a,e)?(i&&m(i,p,255,0,0),u++):i&&m(i,p,255,255,0);else if(i){var v=o(n(o((y=e)[(A=p)+0],S=y[A+3]/255),o(y[A+1],S),o(y[A+2],S)),.1);m(i,p,v,v,v)}}var y,A,S;return u};function r(e,t,i,s,a,l){for(var n,d,h,o,m=Math.max(t-1,0),u=Math.max(i-1,0),g=Math.min(t+1,s-1),f=Math.min(i+1,a-1),p=4*(i*s+t),v=0,y=0,A=0,S=0,w=0,C=m;C<=g;C++)for(var x=u;x<=f;x++)if(C!==t||x!==i){var b=c(e,e,p,4*(x*s+C),!0);if(0===b?v++:b<0?A++:b>0&&y++,v>2)return!1;l&&(b<S&&(S=b,n=C,d=x),b>w&&(w=b,h=C,o=x))}return!l||0!==A&&0!==y&&(!r(e,n,d,s,a)&&!r(l,n,d,s,a)||!r(e,h,o,s,a)&&!r(l,h,o,s,a))}function c(e,t,i,s,a){var l=e[i+3]/255,r=t[s+3]/255,c=o(e[i+0],l),m=o(e[i+1],l),u=o(e[i+2],l),g=o(t[s+0],r),f=o(t[s+1],r),p=o(t[s+2],r),v=n(c,m,u)-n(g,f,p);if(a)return v;var y=d(c,m,u)-d(g,f,p),A=h(c,m,u)-h(g,f,p);return.5053*v*v+.299*y*y+.1957*A*A}function n(e,t,i){return.29889531*e+.58662247*t+.11448223*i}function d(e,t,i){return.59597799*e-.2741761*t-.32180189*i}function h(e,t,i){return.21147017*e-.52261711*t+.31114694*i}function o(e,t){return 255+(e-255)*t}function m(e,t,i,s,a){e[t+0]=i,e[t+1]=s,e[t+2]=a,e[t+3]=255}function u(e,t,i){if(f.has(e))return void i(f.get(e));if(g.has(e))return void g.get(e).push(i);g.set(e,[i]);const s=document.createElement("script");s.src=t,document.head.appendChild(s)}window.loadScreenshot=((e,t)=>{const i=g.get(e);i&&(i.forEach(e=>e(t)),g.delete(e)),f.set(e,t)});const g=new Map,f=new Map;class p{constructor(){this.imageASrc="",this.imageBSrc="",this.imagesLoaded=new Set,this.isImageALoaded=!1,this.isImageBLoaded=!1,this.initializeCalculateMismatch=!1,this.hasCalculatedMismatch=!1}componentWillLoad(){this.loadScreenshots()}componentWillUpdate(){this.loadScreenshots()}loadScreenshots(){if(!this.hidden)return this.diff.identical?(this.imageASrc=this.imagesUrl+this.diff.imageA,void(this.imageBSrc=this.imagesUrl+this.diff.imageA)):void(this.initializeCalculateMismatch||(this.imageAClass="is-loading",this.imageBClass="is-loading",this.canvasClass="is-loading",this.initializeCalculateMismatch=!0,null!=this.diff.imageA&&u(this.diff.imageA,this.diff.jsonpUrlA,e=>{this.imageASrc=e,this.imageAClass="has-loaded",this.isImageALoaded=!0}),null!=this.diff.imageB&&u(this.diff.imageB,this.diff.jsonpUrlB,e=>{this.imageBSrc=e,this.imageBClass="has-loaded",this.isImageBLoaded=!0})))}async compareImages(){const e=this.diff;this.isImageALoaded&&this.isImageBLoaded&&!this.hasCalculatedMismatch&&(this.hasCalculatedMismatch=!0,e.mismatchedPixels=await function(e,t,i,s,a){const r=document.createElement("canvas");r.width=s,r.height=a;const c=document.createElement("canvas");c.width=s,c.height=a;const n=r.getContext("2d");n.drawImage(e,0,0);const d=c.getContext("2d");d.drawImage(t,0,0);const h=document.createElement("canvas").getContext("2d");h.drawImage(e,0,0),h.getImageData(0,0,s,a);const o=n.getImageData(0,0,s,a).data,m=d.getImageData(0,0,s,a).data,u=i.getContext("2d"),g=u.createImageData(s,r.height),f=l(o,m,g.data,s,a,{threshold:.1});return u.putImageData(g,0,0),f}(this.imageA,this.imageB,this.canvas,Math.round(e.width*e.deviceScaleFactor),Math.round(e.height*e.deviceScaleFactor)),this.canvasClass="has-loaded",function(t,i,s){const l=a(e.imageA,e.imageB);localStorage.setItem(l,String(s))}(0,0,e.mismatchedPixels),this.compareLoaded.emit())}render(){const t=this.diff,i={width:t.width+"px",height:t.height+"px"};return[e("compare-cell",null,e("img",{src:this.imageASrc,class:this.imageAClass,style:i,onLoad:this.diff.identical?null:this.compareImages.bind(this),ref:e=>this.imageA=e})),e("compare-cell",null,e("img",{src:this.imageBSrc,class:this.imageBClass,style:i,onLoad:this.diff.identical?null:this.compareImages.bind(this),ref:e=>this.imageB=e})),e("compare-cell",null,this.diff.identical?e("img",{style:i,src:this.imageASrc}):e("canvas",{width:Math.round(t.width*t.deviceScaleFactor),height:Math.round(t.height*t.deviceScaleFactor),class:this.canvasClass,style:i,ref:e=>this.canvas=e})),e("compare-cell",null,e("compare-analysis",{diff:this.diff}))]}static get is(){return"compare-row"}static get properties(){return{canvasClass:{state:!0},diff:{type:"Any",attr:"diff"},elm:{elementRef:!0},hidden:{type:Boolean,attr:"hidden",reflectToAttr:!0},imageAClass:{state:!0},imageASrc:{state:!0},imageBClass:{state:!0},imageBSrc:{state:!0},imagesUrl:{type:String,attr:"images-url"}}}static get events(){return[{name:"compareLoaded",method:"compareLoaded",bubbles:!0,cancelable:!0,composed:!0}]}static get style(){return"compare-row canvas,compare-row img{-webkit-box-shadow:var(--screenshot-box-shadow);box-shadow:var(--screenshot-box-shadow);border-radius:var(--screenshot-border-radius)}.is-loading{visibility:hidden}"}}class v{render(){let t=0;this.a.screenshots.forEach(e=>{e.width>t&&(t=e.width)});const i={width:(t+=8)+"px"};return[e("th-cell",null,e("div",{style:i},this.a.message)),e("th-cell",null,e("div",{style:i},this.b.message)),e("th-cell",null,e("div",{style:i},"Diff")),e("th-cell",{class:"analysis"},e("div",null,"Analysis"))]}static get is(){return"compare-thead"}static get encapsulation(){return"shadow"}static get properties(){return{a:{type:"Any",attr:"a"},b:{type:"Any",attr:"b"}}}static get style(){return".sc-compare-thead-h{display:-webkit-box;display:-ms-flexbox;display:flex}th-cell.sc-compare-thead{display:block;-webkit-box-flex:1;-ms-flex:1;flex:1;font-weight:500;font-size:12px}th-cell.sc-compare-thead   div.sc-compare-thead{padding-left:12px}.analysis.sc-compare-thead   div.sc-compare-thead{width:262px}"}}class y{constructor(){this.diffs=[]}componentWillLoad(){this.filter=function(){const e={},t=location.hash.replace("#","");return""!==t&&t.split(";").forEach(t=>{const i=t.split("-");e[i[0]]=!(i.length>1)||i[1]}),e}(),this.diffs=function(e,t,i,s){const l=e.screenshots.map(e=>({id:e.id,desc:e.desc,testPath:e.testPath,imageA:e.image,imageUrlA:`${i}${e.image}`,jsonpUrlA:`${s}screenshot_${e.image}.js`,imageB:null,imageUrlB:null,jsonpUrlB:null,imageDiff:null,identical:!1,mismatchedPixels:null,width:e.width,height:e.height,deviceScaleFactor:e.deviceScaleFactor,device:e.device||e.userAgent,hidden:!0}));return t.screenshots.forEach(e=>{let t=l.find(t=>t.id===e.id);t?(t.imageB=e.image,t.imageUrlB=`${i}${e.image}`,t.jsonpUrlB=`${s}screenshot_${e.image}.js`):l.push(t={id:e.id,desc:e.desc,testPath:e.testPath,imageA:null,imageUrlA:null,jsonpUrlA:null,imageB:e.image,imageUrlB:`${i}${e.image}`,jsonpUrlB:`${s}screenshot_${e.image}.js`,imageDiff:null,identical:!1,mismatchedPixels:null,width:e.width,height:e.height,deviceScaleFactor:e.deviceScaleFactor,device:e.device||e.userAgent,hidden:!0})}),l.forEach(e=>{if(e.identical=e.imageUrlA===e.imageUrlB,e.identical)return void(e.mismatchedPixels=0);const t=function(t,i){const s=a(e.imageA,e.imageB),l=localStorage.getItem(s);if("string"==typeof l){const e=parseInt(l,10);if(!isNaN(e))return e}return null}();"number"==typeof t&&(e.mismatchedPixels=t,0===e.mismatchedPixels&&(e.identical=!0))}),l}(this.a,this.b,this.imagesUrl,this.jsonpUrl),this.updateDiffs()}filterChange(e){this.filter=function(t,i){const s=Object.assign({},t,e.detail),a=Object.keys(s),l=[];return a.map(e=>{const t=s[e];!0===t?l.push(e):null!=t&&""!==t&&l.push(e+"-"+t)}),window.location.hash=l.sort().join(";"),s}(this.filter),this.updateDiffs()}compareLoaded(){this.updateDiffs()}updateDiffs(){var e;this.diffs=(e=this.filter,this.diffs.map(t=>(t=Object.assign({},t),function(e,t){const i=!e.device||e.device===t.device,s=!e.search||t.desc.includes(e.search);let a=!0;return e.mismatch?null!=t.mismatchedPixels&&"all"!==e.mismatch&&(a=parseInt(e.mismatch,10)<t.mismatchedPixels):a=t.mismatchedPixels>0||null==t.mismatchedPixels,t.hidden=!(i&&s&&a),t}(e,t))).sort((e,t)=>e.mismatchedPixels>t.mismatchedPixels?-1:e.mismatchedPixels<t.mismatchedPixels?1:e.desc.toLowerCase()<t.desc.toLowerCase()?-1:e.desc.toLowerCase()>t.desc.toLowerCase()?1:e.device.toLowerCase()<t.device.toLowerCase()?-1:e.device.toLowerCase()>t.device.toLowerCase()?1:0))}render(){return[e("compare-header",{diffs:this.diffs,filter:this.filter,appSrcUrl:this.appSrcUrl}),e("section",{class:"scroll-x"},e("compare-thead",{a:this.a,b:this.b}),e("section",{class:"scroll-y"},e("compare-table",null,e("compare-tbody",null,this.diffs.map(t=>e("compare-row",{key:t.id,id:"d-"+t.id,hidden:t.hidden,imagesUrl:this.imagesUrl,diff:t}))))))]}static get is(){return"screenshot-compare"}static get properties(){return{a:{type:"Any",attr:"a"},appSrcUrl:{type:String,attr:"app-src-url"},b:{type:"Any",attr:"b"},buildIdA:{type:String,attr:"build-id-a"},buildIdB:{type:String,attr:"build-id-b"},filter:{state:!0},imagesUrl:{type:String,attr:"images-url"},jsonpUrl:{type:String,attr:"jsonp-url"}}}static get listeners(){return[{name:"filterChange",method:"filterChange"},{name:"compareLoaded",method:"compareLoaded"}]}}export{t as CompareAnalysis,i as CompareFilter,s as CompareHeader,p as CompareRow,v as CompareThead,y as ScreenshotCompare};